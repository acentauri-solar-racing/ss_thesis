% !TeX spellcheck = en_US
% !TeX encoding = UTF-8
% !TeX root = ../report.tex

\chapter{Energy Usage Optimization and Long-Term Strategy}
\label{chp:strategy}
This chapter outlines the process for obtaining a realistic SoC reference profile for the cascaded cruise controller as a function of the driven distance. The goal is to minimize the driving time or, equivalently, optimize energy usage by ensuring that the energy spent exactly matches the energy budget at the end of the race. However, this method can result in solutions that do not respect the lower bound of the SoC throughout the race. To address this issue, a smaller constant mean velocity is determined such that the SoC trajectory exactly reaches the $x_\mathrm{SoC,min}$ at the point where the worst violation is detected.

Although this approach avoids the need for complex optimization algorithms, it presents several challenges due to the time/space nature of the problem. In fact, the SoC profile is shaped by the occurrence of recharging possibilities, namely during the overnight stops in time domain and control stops in space domain. Additionally, these stops sometimes overlap, further increasing the complexity. To address these challenges, the chapter is structured to first present the underlying idea with the help of an example that does not include control stops: Derivations in time domain are explained in~\cref{sec:strategyTimeDomain}, followed by the space domain in~\cref{sec:strategySpaceDomain}. Subsequently, practical consideration such as the possible intersection between the energies during an overnight stop, overlapping between control and overnight stops, and lower bound violations are explained in~\cref{sec:strategyPracticalConsideration}. Finally, a flow diagram representation of the recursive algorithm that connects the two domains and includes the aforementioned considerations is presented in~\cref{sec:strategyRecursiveAlgo}.
 

\section{General Concept}
As previously mentioned, the idea behind the strategy optimization is to ensure that the complete energy budget is used during the race. Mathematically, this can be expressed with the following expression:
\begin{equation}
	E_\mathrm{loss}(d_\mathrm{tot}) \overset{!}{=} E_\mathrm{budg}(d_\mathrm{tot}) \label{eq:strategyEgoalDtot}
\end{equation}
where $E_\mathrm{loss}$ is the energy loss function, $E_\mathrm{budg}$ is the energy budget function, and $d_\mathrm{tot}$ is total length of the race. To allow the detailed derivation of these two quantities in~\cref{sec:strategyTimeDomain}, a first conversion from space to time domain is needed. This is performed by assuming a constant mean velocity over the entire race:
\begin{equation}
	\overline{v}_\mathrm{tot} = \frac{d_\mathrm{tot}}{t_\mathrm{driv}} \label{eq:strategyMeanVelTot}
\end{equation}
where $t_\mathrm{driv}$ is the driving time, i.e., the time when the car is moving. Assuming a minimal driving time $t_\mathrm{driv}^*$ and an optimal mean velocity $\overline{v}_\mathrm{tot,opt}$,~\cref{eq:strategyEgoalDtot} can be reformulated to
\begin{equation}
	E_\mathrm{loss}(t_\mathrm{driv}^* \cdot \overline{v}_\mathrm{tot,opt}) \overset{!}{=} E_\mathrm{budg}(t_\mathrm{driv}^* \cdot \overline{v}_\mathrm{tot,opt}).
\end{equation}
This is graphically shown in~\cref{fig:strategyEintersectionUnitedStops} as an intersection of the two curves: in blue the energy loss and in black the energy budget. 
\begin{figure}[htbp]
	\centering
	\begin{externalize}{intersectionStrategy}
			\input{img/intersectionStrategy/intersectionStrategy.tex}
		\end{externalize}
	\caption{Graphical representation of the intersection between the energy budget and energy loss as a function of driving time. The vertical lines represent the overnight stops.}
	\label{fig:strategyEintersection}
\end{figure}

After this step into time domain, the analysis of the energy content in the battery as a function of the driven distance can be performed in the space domain, as explained in~\cref{sec:strategySpaceDomain}.


\subsection{Time Domain}
\label{sec:strategyTimeDomain}
The energy budget and energy loss values are derived in the following paragraphs.

\paragraph{Energy Budget}
The available energy budget for the race is calculated by adding the energy generated by the solar panels and the energy stored in the battery. To ensure safety, the battery is not fully depleted during the race and is used within certain limits.
\begin{equation}
	E_\mathrm{budg}(t_\mathrm{driv}) = E_\mathrm{PV}(t_\mathrm{driv}) + E_\mathrm{bat,safe}. \label{eq:strategyEbudgetTotTime}
\end{equation}
The PV energy is the first contribution and is found as follows:
\begin{equation}
	E_\mathrm{PV} = \int \tilde{P}_\mathrm{PV}(t) \;\mathrm{d}t = \int A_\mathrm{PV} \cdot G(t) \cdot \eta_\mathrm{PV} \cdot \tilde{\eta}_\mathrm{CF} \cdot \eta_\mathrm{loss} \;\mathrm{d}t
\end{equation}
where $\tilde{\eta}_\mathrm{CF}$ is assumed constant with an estimated value of 0.979 by considering $\overline{T}_\mathrm{amb} = \unit[28]{\celsius}$ and $\overline{v}_\mathrm{eff} = \unitfrac[112]{km}{h}$ in~\cref{eq:modelingPVtempPV}.

The second contribution is the energy that the battery can provide and it is represented by a fraction of the total energy stored at the beginning of the race:
\begin{equation}
	E_\mathrm{bat,safe} = (x_\mathrm{SoC,max} - x_\mathrm{SoC,min}) \cdot E_\mathrm{bat,max}. \label{eq:strategyEbatSafe}
\end{equation}
\Cref{eq:strategyEbatSafe} assumes that the state of energy (SoE) is equal to the SoC by assuming a constant open-circuit voltage~\cite{fawidmer:2016mt}.
\begin{equation}
	x_\mathrm{SoE} = \frac{1}{E_\mathrm{bat,max}} \cdot \int_{Q_\mathrm{bat,max}}^{Q_\mathrm{bat}} U_\mathrm{bat,oc} \;\mathrm{d} Q_\mathrm{bat}^* = \frac{1}{Q_\mathrm{bat,max}} \cdot \int_{0}^{t} - \eta_\mathrm{c} \cdot I_\mathrm{bat}(t) \;\mathrm{d}t = x_\mathrm{SoC}. \label{eq:strategySoCequalSoE}
\end{equation}


\paragraph{Energy Loss}
During the race, the car loses energy due to inefficiency in the components, rolling friction between the wheels and the road, and aerodynamic friction with the surrounding air.
\begin{equation}
	E_\mathrm{loss} = E_\mathrm{ineff} + E_\mathrm{roll} + E_\mathrm{aero} \label{eq:strategyElossSum}
\end{equation}
To simplify this expression, the energy inefficiency $E_\mathrm{ineff}$ is summarized as a constant inefficiency parameter $\eta_\mathrm{ineff}$, which is explained in~\cref{eq:strategyInefficiency} to~\cref{eq:strategyBearForce} below. Therefore,~\cref{eq:strategyElossSum} can be rewritten as
\begin{align}
	E_\mathrm{loss} &= \frac{1}{\eta_\mathrm{ineff}} \cdot (E_\mathrm{roll} + E_\mathrm{aero}) \label{eq:strategyElossApproxIneff}\\
	&= \frac{1}{\eta_\mathrm{ineff}} \cdot (F_\mathrm{roll} \cdot d_\mathrm{tot} + F_\mathrm{aero} \cdot d_\mathrm{tot}) \\
	&= \frac{d_\mathrm{tot}}{\eta_\mathrm{ineff}} \cdot \left(c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g + \frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero} \cdot \overline{v}_\mathrm{tot}^2 \right) \label{eq:strategyELossVel}
\end{align}
where $E_\mathrm{roll}$ is the energy loss due to rolling friction and $E_\mathrm{aero}$ is the energy loss due to aerodynamic friction.~\Cref{fig:inclination} shows that the inclination of the road is relative small. Hence, $F_\mathrm{roll}$ can be approximated as independent on time or distance:
\begin{equation}
	F_\mathrm{roll} = c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g \quad , \quad \text{if} \quad v \geq 0
\end{equation}

In order to calculate $\eta_\mathrm{ineff}$ as accurately as possible, its value is estimated using the results of a single day simulation. Combining~\cref{eq:strategyElossSum} with~\cref{eq:strategyElossApproxIneff} yields
\begin{equation}
	\eta_\mathrm{ineff} \approx \frac{\tilde{E}_\mathrm{roll} + \tilde{E}_\mathrm{aero}}{\tilde{E}_\mathrm{ineff} + \tilde{E}_\mathrm{roll} + \tilde{E}_\mathrm{aero}} \label{eq:strategyInefficiency}
\end{equation}
where the estimated energy loss due to inefficiency is obtained by considering the losses that occur in the motor, battery, and bearing:
\begin{equation}
	\tilde{E}_\mathrm{ineff} = \tilde{E}_\mathrm{mot,loss} + \tilde{E}_\mathrm{bat,loss} + \tilde{E}_\mathrm{bear}.
\end{equation}
All estimated energy contributions are obtained as follows:
\begin{align}
	\tilde{E}_\mathrm{roll} &= \int F_\mathrm{roll}(t_\mathrm{sim}) \cdot v(t_\mathrm{sim}) \;\mathrm{d}t_\mathrm{sim} \\
	\tilde{E}_\mathrm{aero} &= \int F_\mathrm{aero}(t_\mathrm{sim}) \cdot v(t_\mathrm{sim}) \;\mathrm{d}t_\mathrm{sim} \\
	\tilde{E}_\mathrm{mot,loss} &= \int P_\mathrm{mot,el}(t_\mathrm{sim}) - P_\mathrm{mot,mec}(t_\mathrm{sim}) \;\mathrm{d}t_\mathrm{sim} \\
	\tilde{E}_\mathrm{bat,loss} &= \int R_\mathrm{bat} \cdot I_\mathrm{bat}^2(t_\mathrm{sim}) \;\mathrm{d}t_\mathrm{sim} \\
	\tilde{E}_\mathrm{bear} &= F_\mathrm{bear} \cdot d_\mathrm{tot} \label{eq:strategyBearForce}
\end{align}
resulting in an approximated value of
\begin{equation}
	\eta_\mathrm{ineff} = 0.93.
\end{equation}
Therefore, inserting~\cref{eq:strategyMeanVelTot} in~\cref{eq:strategyELossVel} results in the equation of interest for the energy loss, where it becomes a function of the driving time only:
\begin{equation}
	E_\mathrm{loss}(t_\mathrm{driv}) = \frac{d_\mathrm{tot}}{\eta_\mathrm{ineff}} \cdot \left(c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g + \frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero} \left(\frac{d_\mathrm{tot}}{t_\mathrm{driv}}\right)^2\right). \label{eq:strategyELossTime}
\end{equation}
Really small values of the driving time to finish the race corresponds to a high mean velocity, and subsequently, a high aerodynamic energy loss.

Therefore, the minimal driving time is finally determined by the intersection of the two energy functions just derived as shown in~\cref{fig:strategyEintersection}. As a result, the optimal average velocity is obtained:
\begin{equation}
	\overline{v}_\mathrm{tot,opt} = \frac{d_\mathrm{tot}}{t_\mathrm{driv}^*}. \label{eq:strategyOptMeanVelTot}
\end{equation}


\subsection{Space Domain}
\label{sec:strategySpaceDomain}
The objective in the spatial domain is to express the energy content of the battery in terms of distance, as depicted in~\cref{fig:strategyEbat}.
\begin{figure}[htbp]
	\centering
	\begin{externalize}{EbatStrategy}
		\input{img/EbatStrategy/EbatStrategy.tex}
	\end{externalize}
	\caption{Simplified battery energy content where only the overnight stops are considered. The vertical lines represents the overnight stops.}
	\label{fig:strategyEbat}
\end{figure}

The equation for the SoC is obtained by dividing the battery energy by the maximum stored energy and utilizing~\cref{eq:strategySoCequalSoE}.
\begin{equation}
	x_\mathrm{SoC}(d) = x_\mathrm{SoE}(d) = \frac{E_\mathrm{bat}(d)}{E_\mathrm{bat,max}} 
\end{equation}

\paragraph{Battery Energy}
The energy content in the battery is found as a function of the driven distance
\begin{equation}
	E_\mathrm{bat}(d) = E_\mathrm{bat,max} + E_\mathrm{PV}(d) - E_\mathrm{loss}(d), \label{eq:strategyEbatDist}
\end{equation}
where the energy loss of~\cref{eq:strategyELossTime} can be rewritten as a function of distance by exploiting the optimal mean velocity found in~\cref{eq:strategyOptMeanVelTot}:
\begin{equation}
	E_\mathrm{loss}(d) = \frac{d}{\eta_\mathrm{ineff}} \cdot \left(c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g + \frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero} \cdot \overline{v}_\mathrm{tot,opt}^2 \right)
\end{equation}

In all these calculations, the potential energy shown in~\cref{fig:potEnergy} is neglected because its values are small compared to the other energy contributions of~\cref{eq:strategyEbatDist}.
\begin{equation}
	E_\mathrm{pot}(d) = m_\mathrm{tot} \cdot g \cdot h(d)
\end{equation}
\begin{figure}[htbp]
	\centering
	\begin{externalize}{potEnergy}
		\input{img/potEnergy/potEnergy.tex}
	\end{externalize}
	\caption{Potential energy plotted as a function of distance.}
	\label{fig:potEnergy}
\end{figure}

\newpage
\section{Practical Considerations}
\label{sec:strategyPracticalConsideration}
This section addresses exceptional edge cases that must be considered in order to achieve accurate and practical outcomes.


\subsection{Intersection During Overnight Stop}
\label{sec:strategyIntDuringOvernight}
The first exceptional case to be taken into account is that the energy budget curve might intersect the energy loss curve during an overnight stop. In~\ref{fig:strategyEintersectionUnitedStopsError}, this occurrence happens at the end of the fourth day.
\begin{figure}[htbp]
	\centering
	\begin{externalize}{intersectionStrategyUnitedStopsError}
		\input{img/intersectionStrategyUnitedStopsError/intersectionStrategyUnitedStopsError.tex}
	\end{externalize}
	\caption{Graphical representation of the intersection between the energy budget and energy loss during an overnight stop. The vertical line represents the fourth overnight stop.}
	\label{fig:strategyEintersectionUnitedStopsError}
\end{figure}

In this scenario, the actual driving time to finish the race will exceed $t_\mathrm{driv}^*$, as some energy is required to drive the final kilometers without using energy that is below $x_\mathrm{SoC,min}$. The energy needed is determined by subtracting the energy budget at the start of the overnight stop from the value at the intersection, while the remaining energy in the battery is found by subtracting the value at the end of the overnight stop from the value at the intersection. Therefore, the velocity has to be decreased by following the explanations in~\cref{sec:strategyLBviolation} below. Additionally, it is possible that the race is completed with some energy still remaining in the battery, as the velocity cannot exceed $v_\mathrm{cruise}$. This type of velocity adjustments is explained in~\cref{sec:strategyEleft} below.


\subsection{Overlapping Stops}
\label{sec:strategyOverlapStops}
The second exceptional case must be considered to accurately account for control stops that occur after 16:30. As explained in~\cref{sec:bwscRules}, the official rules impose that the time of a control stop is not spent during the overnight stops, but recovered from 08:00 on the following day. For instance, if a team stops at 16:50, the next day it can start driving at 08:20. This becomes relevant once the optimal mean velocity is calculated and the control stop cuts can be performed in time domain, as explained in~\cref{sec:strategyRecursiveAlgo} below. 


\subsection{Lower Bound Violation}
\label{sec:strategyLBviolation}
A further example of an exceptional case is shown in~\cref{fig:strategySoC} as the SoC profile violates the lower bound around the third overnight stop.
\begin{figure}[htbp]
	\centering
	\begin{externalize}{SoCstrategy}
		\input{img/SoCstrategy/SoCstrategy.tex}
	\end{externalize}
	\caption{Simplified SoC profile where only the overnight stops are considered. The SoC at the end of the race is precisely equal to the lower bound. The vertical lines represents the overnight stops.}
	\label{fig:strategySoC}
\end{figure}

To address this problem, the average velocity must be reduced to decrease the energy loss caused by the aerodynamic friction. The new average velocity should ensure that the energy budget is equivalent to the energy loss at the point of the worst violation, i.e., in the evening of the third day in this example. This can be mathematically represented by the following energy balance equation:
\begin{align}
	E_\mathrm{budg,det} &\overset{!}{=} E_\mathrm{loss,det}(\overline{v}_\mathrm{det}) \\
	E_\mathrm{PV,det} + E_\mathrm{bat,safe} &\overset{!}{=} \frac{\overline{v}_\mathrm{det} \cdot t_\mathrm{driv,det}}{\eta_\mathrm{ineff}} \cdot \left(c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g + \frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero} \cdot \overline{v}_\mathrm{det}^2 \right) \label{eq:strategyEbalanceDetection}
\end{align}
where $\overline{v}_\mathrm{det}$ is the new mean velocity that guarantees that the $x_\mathrm{SoC,min}$ is respected where the worst violation is detected, as illustrated in~\cref{fig:strategySoCsafe}, and $t_\mathrm{driv,det}$ is the driving time until this violation. It is assumed that the worst violations can only occur at 17:00 of each day.
\begin{figure}[htbp]
	\centering
	\begin{externalize}{SoCsafeStrategy}
		\input{img/SoCsafeStrategy/SoCsafeStrategy.tex}
	\end{externalize}
	\caption{Simplified SoC profile where only the overnight stops are considered. The SoC where the worst detection occurs is precisely equal to the lower bound. The vertical lines represents the overnight stops.}
	\label{fig:strategySoCsafe}
\end{figure}

The PV energy until detection is calculated as follows:
\begin{equation}
	E_\mathrm{PV,det} = \int_{0}^{t_\mathrm{driv,det}} \tilde{P}_\mathrm{PV}(t) \;\mathrm{d}t = \int_{0}^{t_\mathrm{driv,det}} A_\mathrm{PV} \cdot G(t) \cdot \eta_\mathrm{PV} \cdot \tilde{\eta}_\mathrm{CF} \cdot \eta_\mathrm{loss} \;\mathrm{d}t.
\end{equation}
To better analyze~\cref{eq:strategyEbalanceDetection}, it can be rewritten as a third order polynomial:
\begin{equation}
	\overline{v}_\mathrm{det}^3 + \underbrace{\frac{c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g}{\frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero}}}_{p} \cdot \overline{v}_\mathrm{det} + \underbrace{\frac{- \frac{\eta_\mathrm{ineff}}{t_\mathrm{det}} \cdot \left(E_\mathrm{PV,det} + E_\mathrm{bat,safe} \right)}{\frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero}}}_{q} = 0. \label{eq:strategy3poly}
\end{equation}
The three possible solutions of~\cref{eq:strategy3poly} are investigated by considering the following relation between the coefficients $p$ and $q$, as explained in~\cite{wikipediaCardano:2022webpage}:
\begin{equation}
	\Delta = \frac{q^2}{4} + \frac{p^3}{27} \quad
	\begin{cases}
		> 0 \qquad & \Rightarrow \quad \text{1 real and 2 complex solutions}, \\
		< 0 \qquad & \Rightarrow \quad \text{3 real solutions}.
	\end{cases}
\end{equation}
The first case is always true, in fact $p > 0$ and $q^2 > 0$. Therefore, Cardano's equation can be used to find the single real solution:
\begin{equation}
	\overline{v}_\mathrm{det} = \sqrt[3]{u_1} +  \sqrt[3]{u_2}
\end{equation}
with
\begin{equation}
	u_1 = - \frac{q}{2} + \sqrt{\Delta} \qquad \text{and} \qquad u_2 = - \frac{q}{2} - \sqrt{\Delta}.
\end{equation}
To ensure that more energy is stored in the battery, its value must be smaller than the optimal velocity:
\begin{equation}
	\overline{v}_\mathrm{det} < \overline{v}_\mathrm{tot,opt}.
\end{equation}


\subsection{Energy Optimization After Corrected Worst Violation}
\label{sec:strategyEleft}
The final strategy discussed in~\ref{sec:strategyLBviolation} ensures that the $x_\mathrm{SoC,min}$ is met exactly at the position of the worst violation by decreasing the average velocity. However, after implementing this strategy, the car will have some remaining energy in the battery at the end of the race. Similarly, the first scenario presented in~\ref{sec:strategyIntDuringOvernight} also has this outcome. Therefore, it is possible to apply the same logic used in~\ref{sec:strategyTimeDomain} to determine the optimal average velocity that balances the energy usage between the corrected violation and the end of the race. Therefore, the energy balance equation is as follows:
\begin{equation}
	E_{\mathrm{budg,det,end}} \overset{!}{=} E_{\mathrm{loss,det,end}}(t_\mathrm{driv}). \label{eq:strategyEgoalDetEnd}
\end{equation}
The energy loss as function of the driving time is found as
\begin{equation}
	E_{\mathrm{loss,det,end}} = \frac{d_\mathrm{tot} - d_\mathrm{det}}{\eta_\mathrm{ineff}} \cdot \left(c_\mathrm{roll} \cdot m_\mathrm{tot} \cdot g + \frac{1}{2} \cdot \rho_\mathrm{air} \cdot A_\mathrm{front} \cdot c_\mathrm{aero} \left(\frac{d_\mathrm{tot} - d_\mathrm{det}}{t_\mathrm{driv} - t_\mathrm{driv,det}} \right)^2 \right),
\end{equation}
where $d_\mathrm{det}$ is the distance traveled until the corrected worst detection and similarly, $t_\mathrm{driv,det}$ is the driving time until the corrected worst detection. The two contributions of the energy budget are represented by the following equations:
\begin{align}
	E_\mathrm{PV,det,end} &= \int_{t_\mathrm{driv,det}}^{t_\mathrm{end}} \tilde{P}_\mathrm{PV}(t) \;\mathrm{d}t = \int_{t_\mathrm{driv,det}}^{t_\mathrm{end}} A_\mathrm{PV} \cdot G(t) \cdot \eta_\mathrm{PV} \cdot \tilde{\eta}_\mathrm{CF} \cdot \eta_\mathrm{loss} \;\mathrm{d}t, \\
	E_\mathrm{bat,safe,det} &= (x_\mathrm{SoC,det} - x_\mathrm{SoC,min}) \cdot E_\mathrm{bat,max}.
\end{align}
By exploiting the intersection between the two new curves, is it possible to find the optimal driving time between violation and finish line where~\cref{eq:strategyEgoalDetEnd} is satisfied. Therefore, the mean velocity of this segment is as follows:
\begin{equation}
	\overline{v}_\mathrm{det,end} = \frac{d_\mathrm{tot} - d_\mathrm{det}}{t_\mathrm{driv,end}^* - t_\mathrm{driv,det}}.
\end{equation}
This velocity cannot exceed the maximal cruise velocity:
\begin{equation}
	\overline{v}_\mathrm{det,end} \leq v_\mathrm{cruise}.
\end{equation}

Due to time constraints, this part is not going to be integrated in the final code. Nevertheless, the recursive algorithm explained in the following section takes this scenario into consideration.
%Control stops:
%\begin{equation}
%	d_{\mathrm{cs},j} \quad t_{\mathrm{driv,cs},j} \qquad j = 1, 2, ... , 9
%\end{equation}
%Overnight stops:
%\begin{equation}
%	t_{\mathrm{driv,os},k} \quad d_{\mathrm{os},k} \qquad k = 1, 2, ...
%\end{equation}

\newpage
\section{Recursive Algorithm}
\label{sec:strategyRecursiveAlgo}
In this section, a recursive algorithm that generates the reference SoC profile is presented. It incorporates all previously mentioned scenarios and includes the nine control stops that were omitted in earlier examples. The description follows the flow diagram shown in~\cref{fig:recursiveAlgorithm}.

The algorithm starts by calling the Velocity Finder function with the initial set of variables. The optimal mean velocity $\overline{v}_\mathrm{tot,opt}$ is calculated, as described in detail in~\cref{sec:strategyTimeDomain}. The only difference is that in this case, the control stops are taken into account. Specifically, the total time spent at control stops is subtracted from the overall driving time at the start of the race, as graphically shown in~\cref{fig:strategyEintersectionUnitedStops}. This adjustment is necessary because the energy loss function depends on the driving time, rather than the timing of the stops. Thus, it is crucial to consider these nine stops before the intersection.
\begin{figure}[htbp]
	\centering
	\begin{externalize}{intersectionStrategyUnitedStops}
		\input{img/intersectionStrategyUnitedStops/intersectionStrategyUnitedStops.tex}
	\end{externalize}
	\caption{Graphical representation of the intersection between the energy budget and energy loss as a function of driving time. The vertical lines represent the overnight stops, while the nine control stops are accounted for at the beginning of the race.}
	\label{fig:strategyEintersectionUnitedStops}
\end{figure}

At this point, the exceptional case mentioned in~\cref{sec:strategyIntDuringOvernight} could occur.

Once the optimal mean velocity is determined, the control stop positions can be converted to time. This enables the Overlaps Corrector to make adjustments for the scenario outlined in~\cref{sec:strategyOverlapStops}. Furthermore, the equations in the space domain are calculated as explained in~\cref{sec:strategySpaceDomain}.

Afterwards, the Violation Detector checks whether all SoC values meet the lower bound.
\begin{itemize}
	\item If any violation is identified, the problem is divided at the point of worst violation: The left portion in~\cref{fig:recursiveAlgorithm} is resolved using the methods outlined in~\cref{sec:strategyLBviolation} with the goal of matching the SoC of the worst violation with $x_\mathrm{SoC,min}$, while the right portion is solved using the equations in~\cref{sec:strategyEleft} with the goal of finding the mean velocity that ensures all available energy is used. The recursion is necessary because all possible violations must be individually addressed. After both the left and right loops are completed, the resulting signals must be concatenated to form the final results.
	\item On the other hand, if no violation is detected, the SoC Generator is called and the reference SoC profile is finally generated.
\end{itemize}

\begin{figure}[htbp]
	\centering
	\begin{externalize}{recursiveAlgorithm}
		\input{img/recursiveAlgorithm/recursiveAlgorithm.tex}
	\end{externalize}
	\caption{Flow diagram of the recursive algorithm. Gray rectangles represent functions, rounded-corner rectangle set of variables, and the white rectangle a binary variable.}
	\label{fig:recursiveAlgorithm}
\end{figure}

